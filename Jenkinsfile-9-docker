pipeline {
    agent none
    stages {
        stage('Back-end') {
            agent {
                docker { image 'maven:3.8.1-adoptopenjdk-11'}
            }
            steps {
                sh 'mvn --version'
            }
        }
        stage('Front-end') {
            agent {
                docker { image 'node:16-alpine'}
            }
            steps {
                sh 'node --version'
                sh '''
                    apk add --no-cache sudo
                    apk update && \
                    sudo apk add --no-cache \
                        curl \
                        bash \
                        jq \
                        sudo \
                        unzip \
                        py3-pip \
                        python3-dev \
                        gcc \
                        musl-dev \
                        libffi-dev \
                        openssl-dev \
                        cargo 
                        
                        # Install Terraform
                        curl -fsSL -o terraform.zip "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" && \
                        unzip terraform.zip && \
                        mv terraform /usr/local/bin/ && \
                        chmod +x /usr/local/bin/terraform && \
                        # Install kubectl
                        curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" && \
                        chmod +x kubectl && \
                        mv kubectl /usr/local/bin/ && \
                        # Install Rust and Cargo
                        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
                        # Ensure Cargo is in PATH
                        export PATH="$HOME/.cargo/bin:$PATH" && \
                        # Install Azure CLI
                        python3 -m pip install --upgrade pip setuptools wheel && \
                        pip install azure-cli && \
                        # Clean up the APK cache to reduce image size
                        sudo apk del gcc musl-dev libffi-dev openssl-dev cargo python3-dev && \
                        sudo rm -rf /var/cache/apk/* terraform.zip
                '''
            }
        }
    }
}