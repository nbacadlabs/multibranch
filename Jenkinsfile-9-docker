pipeline {
  agent any


  environment {
    BRANCH = 'main'
    REPO = 'https://github.com/nbacadlabs/multibranch.git'


    // ARM_ACCESS_KEY = credentials('ARM_ACCESS_KEY')
    ARM_CLIENT_ID = credentials('AZURE_CLIENT_ID')
    ARM_CLIENT_SECRET = credentials('AZURE_CLIENT_SECRET')
    ARM_SUBSCRIPTION_ID = credentials('AZURE_SUBSCRIPTION_ID')
    ARM_TENANT_ID = credentials('AZURE_TENANT_ID')
  }


  stages {


    stage('Checkout Source') {


      steps {
        git branch: "$BRANCH",
            url: "$REPO"
      }
    }


    stage('Terraform - init') {
      steps {
         sh '''
            cd ./05-learning
            terraform init -upgrade
        '''
      }
    }


    stage('Terraform - validate') {
      steps {
          sh 'terraform validate ./05-learning'
      }
    }


    stage('Terraform - plan') {
      steps {
          sh 'terraform plan ./05-learning'
      }
    }


    stage('Terraform - apply') {
      steps {
          sh 'terraform apply ./05-learning -auto-approve'
      }
    }


  }


  post {
    always {
      cleanWs()
    }
  }
} // pipelin